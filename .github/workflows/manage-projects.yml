name: Sync Projects to API

on:
  push:
    paths:
      - "source-projects/*.yaml"
      - "source-projects/*.yml"

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # FULL history needed for multi-commit detection

      - name: Install yq and jq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq
          sudo apt-get update && sudo apt-get install -y jq

      # =============================================================
      # DETECT ADDED / MODIFIED / DELETED FILES (multi-commit safe)
      # =============================================================
      - name: Detect changes across multiple commits
        id: changes
        run: |
          BASE=$(git merge-base HEAD origin/main)   # use origin/master if needed
          echo "Comparing changes from $BASE → HEAD"

          ADDED=$(git diff --name-only --diff-filter=A $BASE HEAD | grep "^source-projects/" || true)
          MODIFIED=$(git diff --name-only --diff-filter=M $BASE HEAD | grep "^source-projects/" || true)
          DELETED=$(git diff --name-only --diff-filter=D $BASE HEAD | grep "^source-projects/" || true)

          echo "Added: $ADDED"
          echo "Modified: $MODIFIED"
          echo "Deleted: $DELETED"

          echo "added=$ADDED" >> $GITHUB_OUTPUT
          echo "modified=$MODIFIED" >> $GITHUB_OUTPUT
          echo "deleted=$DELETED" >> $GITHUB_OUTPUT

      # =============================================================
      # DELETE PROJECTS
      # =============================================================
      - name: Delete Projects
        if: steps.changes.outputs.deleted != ''
        run: |
          for file in ${deleted}; do
            PROJECT_NAME=$(basename "$file" | sed 's/.yaml//; s/.yml//')
            echo "→ Deleting project: $PROJECT_NAME"

            curl --location \
              "https://nov-testing.oea-dev.opsmx.net/gate/ssdservice/v1/scan/project/delete?orgId=${{ secrets.ORG_ID }}&teamId=${{ secrets.TEAM_ID }}" \
              --header "X-OpsMx-Auth: Bearer ${{ secrets.API_TOKEN }}" \
              --header "Content-Type: application/json" \
              --data "[{\"name\":\"$PROJECT_NAME\"}]"
          done
        env:
          deleted: ${{ steps.changes.outputs.deleted }}

      # =============================================================
      # CREATE PROJECTS
      # =============================================================
      - name: Create Projects
        if: steps.changes.outputs.added != ''
        run: |
          for file in ${added}; do
            PROJECT_NAME=$(basename "$file" | sed 's/.yaml//; s/.yml//')
            echo "→ Creating project: $PROJECT_NAME"

            PAYLOAD=$(yq -o=json '.' "$file")

            FINAL_PAYLOAD=$(jq -n \
              --arg name "$PROJECT_NAME" \
              --argjson cfg "$PAYLOAD" \
              '[{name:$name} + $cfg]'
            )

            curl --location \
              "https://nov-testing.oea-dev.opsmx.net/gate/ssdservice/v1/scan/project/upload?orgId=${{ secrets.ORG_ID }}&teamId=${{ secrets.TEAM_ID }}" \
              --header "X-OpsMx-Auth: Bearer ${{ secrets.API_TOKEN }}" \
              --header "Content-Type: application/json" \
              --data "$FINAL_PAYLOAD"
          done
        env:
          added: ${{ steps.changes.outputs.added }}

      # =============================================================
      # UPDATE PROJECTS
      # =============================================================
      - name: Update Projects
        if: steps.changes.outputs.modified != ''
        run: |
          for file in ${modified}; do
            PROJECT_NAME=$(basename "$file" | sed 's/.yaml//; s/.yml//')
            echo "→ Updating project: $PROJECT_NAME"

            PAYLOAD=$(yq -o=json '.' "$file")

            FINAL_PAYLOAD=$(jq -n \
              --arg name "$PROJECT_NAME" \
              --argjson cfg "$PAYLOAD" \
              '[{name:$name} + $cfg]'
            )

            curl --location \
              "https://nov-testing.oea-dev.opsmx.net/gate/ssdservice/v1/scan/project/update?orgId=${{ secrets.ORG_ID }}&teamId=${{ secrets.TEAM_ID }}" \
              --header "X-OpsMx-Auth: Bearer ${{ secrets.API_TOKEN }}" \
              --header "Content-Type: application/json" \
              --data "$FINAL_PAYLOAD"
          done
        env:
          modified: ${{ steps.changes.outputs.modified }}
