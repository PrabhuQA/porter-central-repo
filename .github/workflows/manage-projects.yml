name: Sync Projects to API

on:
  push:
    paths:
      - "projects/*.yaml"
      - "projects/*.yml"

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2   # IMPORTANT: to compare HEAD with previous commit

      - name: Detect added, modified, deleted files
        id: changes
        run: |
          ADDED=$(git diff --name-only --diff-filter=A HEAD^ HEAD | grep "^projects/" || true)
          MODIFIED=$(git diff --name-only --diff-filter=M HEAD^ HEAD | grep "^projects/" || true)
          DELETED=$(git diff --name-only --diff-filter=D HEAD^ HEAD | grep "^projects/" || true)

          echo "Added files: $ADDED"
          echo "Modified files: $MODIFIED"
          echo "Deleted files: $DELETED"

          echo "added=$ADDED" >> $GITHUB_OUTPUT
          echo "modified=$MODIFIED" >> $GITHUB_OUTPUT
          echo "deleted=$DELETED" >> $GITHUB_OUTPUT

      # ---------------------------
      # CREATE Projects
      # ---------------------------
      - name: Call CREATE API
        if: steps.changes.outputs.added != ''
        run: |
          for file in ${added}; do
            echo "Creating project from $file"
            curl -X POST https://your-api.com/projects \
              -H "Content-Type: application/json" \
              --data-binary @"$file"
          done
        env:
          added: ${{ steps.changes.outputs.added }}

      # ---------------------------
      # UPDATE Projects
      # ---------------------------
      - name: Call UPDATE API
        if: steps.changes.outputs.modified != ''
        run: |
          for file in ${modified}; do
            echo "Updating project from $file"
            curl -X PUT https://your-api.com/projects \
              -H "Content-Type: application/json" \
              --data-binary @"$file"
          done
        env:
          modified: ${{ steps.changes.outputs.modified }}

      # ---------------------------
      # DELETE Projects
      # ---------------------------
      - name: Call DELETE API
        if: steps.changes.outputs.deleted != ''
        run: |
          for file in ${deleted}; do
            echo "Deleting project for $file"
            PROJECT_NAME=$(basename "$file" | sed 's/.yaml//; s/.yml//')
            curl -X DELETE "https://your-api.com/projects/$PROJECT_NAME"
          done
        env:
          deleted: ${{ steps.changes.outputs.deleted }}
